name: Deploy to Server

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}  # Permet de cliquer "Run workflow" √† la main

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1) Transfert des fichiers du repo vers le serveur (dans ~/app)
      - name: Upload project to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "."
          target: "~/app"
          overwrite: true
          timeout: 120s

      # 2) Provision + D√©ploiement complet
      - name: Provision & Deploy (Docker, .env, compose up)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "[1/6] V√©rification / installation Docker + compose"
            if ! command -v docker >/dev/null 2>&1; then
              # Installe Docker CE + plugin compose sur Debian 12/13
              sudo apt-get update -y
              sudo apt-get install -y ca-certificates curl gnupg
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(. /etc/os-release && echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
              sudo apt-get update -y
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            fi

            echo "[2/6] Pr√©paration dossier projet"
            cd ~
            mkdir -p app
            cd app

            echo "[3/6] G√©n√©ration du .env c√¥t√© serveur"
            rm -f .env
            {
              echo "############################################################"
              echo "#                     BASE DE DONN√âES"
              echo "############################################################"
              echo "DATABASE_URL_DEV=${{ vars.DATABASE_URL_DEV }}"
              echo "DATABASE_URL_PROD=mysql://${{ vars.DB_USER }}:${{ secrets.DB_PASSWORD }}@db:3306/${{ vars.DB_NAME }}"
              echo

              echo "############################################################"
              echo "#             NEXTAUTH (AUTHENTIFICATION)"
              echo "############################################################"
              echo "NEXTAUTH_URL=${{ vars.NEXTAUTH_URL }}"
              echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}"
              # echo "AUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}"  # si tu utilises Auth.js v5

              echo
              echo "############################################################"
              echo "#                    GOOGLE OAUTH - DEV"
              echo "############################################################"
              echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"
              echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"

              echo
              echo "############################################################"
              echo "#                       STRIPE - DEV"
              echo "############################################################"
              echo "STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}"
              echo "STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}"
              echo "STRIPE_ADHESION_PRICE_CENTS=${{ vars.STRIPE_ADHESION_PRICE_CENTS }}"

              echo
              echo "############################################################"
              echo "#                        EMAIL / SMTP"
              echo "############################################################"
              echo "SMTP_HOST=${{ vars.SMTP_HOST }}"
              echo "SMTP_PORT=${{ vars.SMTP_PORT }}"
              echo "SMTP_SECURE=${{ vars.SMTP_SECURE }}"
              echo "SMTP_USER=${{ vars.SMTP_USER }}"
              echo "SMTP_PASS=${{ secrets.SMTP_PASS }}"
              echo "SMTP_FROM=${{ vars.SMTP_FROM }}"

              echo
              echo "############################################################"
              echo "#                   NEXT PUBLIC (EXPOS√â CLIENT)"
              echo "############################################################"
              echo "NEXT_PUBLIC_APP_URL=${{ vars.NEXT_PUBLIC_APP_URL }}"

              echo
              echo "############################################################"
              echo "#               INTEGRATIONS EXTERNES / R√âSEAUX"
              echo "############################################################"
              echo "INSTAGRAM_GRAPH_TOKEN=${{ secrets.INSTAGRAM_GRAPH_TOKEN }}"

              echo
              echo "############################################################"
              echo "#                 (OPTIONNEL) INFRA / TRAEFIK"
              echo "############################################################"
              echo "DOMAIN=${{ vars.DOMAIN }}"
              echo "TRAEFIK_ACME_EMAIL=${{ vars.TRAEFIK_ACME_EMAIL }}"

              echo
            } >> .env

            echo "[4/6] D√©marrage stack (Traefik + Next.js + MariaDB)"
            # Si un ancien d√©ploiement tourne d√©j√†, on le remplace proprement
            sudo docker compose down || true
            # Build + run
            sudo docker compose up -d --build

            echo "[5/6] (Option) Migrations Prisma si prisma/ existe"
            if [ -d "prisma" ]; then
              sudo docker compose run --rm web npx prisma migrate deploy || true
              sudo docker compose restart web || true
            fi

            echo "[6/6] V√©rification conteneurs"
            sudo docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
            echo "D√©ploiement termin√© üéâ"

